"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Voice {
  static get ERROR_MESSAGES() {
    return {
      to: "Invalid to address",
      msg: "Invalid Text Message",
      maxDigits: "Invalid max digits for TTS prompt",
      byeText: "Invalid bye text for TTS prompt",
      pinCode: "Invalid pin code for TTS confirm",
      failedText: "Invalid failed text for TTS confirm",
      answerUrl: "Invalid answer URL for call"
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition  options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }

  _sendVoiceMessage(endpoint, data, callback) {
    if (!data.to) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.to));
    } else {
      data["api_key"] = this.creds.apiKey;
      data["api_secret"] = this.creds.apiSecret;
      this.options.logger.info("sending TTS message to " + data.to + " with message " + data.text);
      this.options.httpClient.request({
        host: endpoint.host,
        path: _Utils.default.createPathWithQuery(endpoint.path, data)
      }, "POST", (err, apiResponse) => {
        if (!err && apiResponse.status && apiResponse.status > 0) {
          _Utils.default.sendError(callback, new Error(apiResponse["error-text"]), apiResponse);
        } else {
          if (callback) callback(err, apiResponse);
        }
      });
    }
  }
  /**
   * TODO: document
   */


  sendTTSMessage(recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  sendTTSPromptWithCapture(recipient, message, maxDigits, byeText, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
    } else if (!byeText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;
      opts["max_digits"] = maxDigits;
      opts["bye_text"] = byeText;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts-prompt/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  sendTTSPromptWithConfirm(recipient, message, maxDigits, pinCode, byeText, failedText, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
    } else if (!pinCode || pinCode.length !== maxDigits) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.pinCode));
    } else if (!byeText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
    } else if (!failedText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.failedText));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;
      opts["max_digits"] = maxDigits;
      opts["pin_code"] = pinCode;
      opts["bye_text"] = byeText;
      opts["failed_text"] = failedText;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts-prompt/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  call(recipient, answerUrl, opts, callback) {
    if (!answerUrl) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.answerUrl));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["answer_url"] = answerUrl;

      this._sendVoiceMessage({
        host: this.options.restHost || "rest.nexmo.com",
        path: "/call/json"
      }, opts, callback);
    }
  }

}

var _default = Voice;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Wb2ljZS5qcyJdLCJuYW1lcyI6WyJWb2ljZSIsIkVSUk9SX01FU1NBR0VTIiwidG8iLCJtc2ciLCJtYXhEaWdpdHMiLCJieWVUZXh0IiwicGluQ29kZSIsImZhaWxlZFRleHQiLCJhbnN3ZXJVcmwiLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX3NlbmRWb2ljZU1lc3NhZ2UiLCJlbmRwb2ludCIsImRhdGEiLCJjYWxsYmFjayIsIlV0aWxzIiwic2VuZEVycm9yIiwiRXJyb3IiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJsb2dnZXIiLCJpbmZvIiwidGV4dCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwiaG9zdCIsInBhdGgiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJzZW5kVFRTTWVzc2FnZSIsInJlY2lwaWVudCIsIm1lc3NhZ2UiLCJvcHRzIiwiYXBpSG9zdCIsInNlbmRUVFNQcm9tcHRXaXRoQ2FwdHVyZSIsImlzTmFOIiwibGVuZ3RoIiwic2VuZFRUU1Byb21wdFdpdGhDb25maXJtIiwiY2FsbCIsInJlc3RIb3N0Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOzs7O0FBRUEsTUFBTUEsS0FBTixDQUFZO0FBQ1YsYUFBV0MsY0FBWCxHQUE0QjtBQUMxQixXQUFPO0FBQ0xDLE1BQUFBLEVBQUUsRUFBRSxvQkFEQztBQUVMQyxNQUFBQSxHQUFHLEVBQUUsc0JBRkE7QUFHTEMsTUFBQUEsU0FBUyxFQUFFLG1DQUhOO0FBSUxDLE1BQUFBLE9BQU8sRUFBRSxpQ0FKSjtBQUtMQyxNQUFBQSxPQUFPLEVBQUUsa0NBTEo7QUFNTEMsTUFBQUEsVUFBVSxFQUFFLHFDQU5QO0FBT0xDLE1BQUFBLFNBQVMsRUFBRTtBQVBOLEtBQVA7QUFTRDtBQUNEO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0VDLEVBQUFBLFdBQVcsQ0FBQ0MsV0FBRCxFQUE0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LENBQUosR0FBbUI5QixPQUFuQjtBQUNBOEIsTUFBQUEsSUFBSSxDQUFDLFVBQUQsQ0FBSixHQUFtQi9CLE9BQW5CO0FBQ0ErQixNQUFBQSxJQUFJLENBQUMsYUFBRCxDQUFKLEdBQXNCN0IsVUFBdEI7O0FBQ0EsV0FBS00saUJBQUwsQ0FDRTtBQUNFYyxRQUFBQSxJQUFJLEVBQUUsS0FBS2hCLE9BQUwsQ0FBYTBCLE9BQWIsSUFBd0IsZUFEaEM7QUFFRVQsUUFBQUEsSUFBSSxFQUFFO0FBRlIsT0FERixFQUtFUSxJQUxGLEVBTUVwQixRQU5GO0FBUUQ7QUFDRjtBQUVEO0FBQ0Y7QUFDQTs7O0FBQ0UwQixFQUFBQSxJQUFJLENBQUNSLFNBQUQsRUFBWTFCLFNBQVosRUFBdUI0QixJQUF2QixFQUE2QnBCLFFBQTdCLEVBQXVDO0FBQ3pDLFFBQUksQ0FBQ1IsU0FBTCxFQUFnQjtBQUNkUyxxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVbkIsS0FBSyxDQUFDQyxjQUFOLENBQXFCTyxTQUEvQixDQUExQjtBQUNELEtBRkQsTUFFTztBQUNMLFVBQUksQ0FBQzRCLElBQUwsRUFBVztBQUNUQSxRQUFBQSxJQUFJLEdBQUcsRUFBUDtBQUNEOztBQUNEQSxNQUFBQSxJQUFJLENBQUMsSUFBRCxDQUFKLEdBQWFGLFNBQWI7QUFDQUUsTUFBQUEsSUFBSSxDQUFDLFlBQUQsQ0FBSixHQUFxQjVCLFNBQXJCOztBQUNBLFdBQUtLLGlCQUFMLENBQ0U7QUFDRWMsUUFBQUEsSUFBSSxFQUFFLEtBQUtoQixPQUFMLENBQWFnQyxRQUFiLElBQXlCLGdCQURqQztBQUVFZixRQUFBQSxJQUFJLEVBQUU7QUFGUixPQURGLEVBS0VRLElBTEYsRUFNRXBCLFFBTkY7QUFRRDtBQUNGOztBQWpMUzs7ZUFvTEdoQixLIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBVdGlscyBmcm9tIFwiLi9VdGlsc1wiO1xuXG5jbGFzcyBWb2ljZSB7XG4gIHN0YXRpYyBnZXQgRVJST1JfTUVTU0FHRVMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRvOiBcIkludmFsaWQgdG8gYWRkcmVzc1wiLFxuICAgICAgbXNnOiBcIkludmFsaWQgVGV4dCBNZXNzYWdlXCIsXG4gICAgICBtYXhEaWdpdHM6IFwiSW52YWxpZCBtYXggZGlnaXRzIGZvciBUVFMgcHJvbXB0XCIsXG4gICAgICBieWVUZXh0OiBcIkludmFsaWQgYnllIHRleHQgZm9yIFRUUyBwcm9tcHRcIixcbiAgICAgIHBpbkNvZGU6IFwiSW52YWxpZCBwaW4gY29kZSBmb3IgVFRTIGNvbmZpcm1cIixcbiAgICAgIGZhaWxlZFRleHQ6IFwiSW52YWxpZCBmYWlsZWQgdGV4dCBmb3IgVFRTIGNvbmZpcm1cIixcbiAgICAgIGFuc3dlclVybDogXCJJbnZhbGlkIGFuc3dlciBVUkwgZm9yIGNhbGxcIlxuICAgIH07XG4gIH1cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q3JlZGVudGlhbHN9IGNyZWRlbnRpYWxzXG4gICAqICAgIGNyZWRlbnRpYWxzIHRvIGJlIHVzZWQgd2hlbiBpbnRlcmFjdGluZyB3aXRoIHRoZSBBUEkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAqICAgIEFkZGl0aW9uICBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgX3NlbmRWb2ljZU1lc3NhZ2UoZW5kcG9pbnQsIGRhdGEsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFkYXRhLnRvKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy50bykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkYXRhW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZHMuYXBpS2V5O1xuICAgICAgZGF0YVtcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcbiAgICAgIHRoaXMub3B0aW9ucy5sb2dnZXIuaW5mbyhcbiAgICAgICAgXCJzZW5kaW5nIFRUUyBtZXNzYWdlIHRvIFwiICsgZGF0YS50byArIFwiIHdpdGggbWVzc2FnZSBcIiArIGRhdGEudGV4dFxuICAgICAgKTtcbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiBlbmRwb2ludC5ob3N0LFxuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoZW5kcG9pbnQucGF0aCwgZGF0YSlcbiAgICAgICAgfSxcbiAgICAgICAgXCJQT1NUXCIsXG4gICAgICAgIChlcnIsIGFwaVJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgaWYgKCFlcnIgJiYgYXBpUmVzcG9uc2Uuc3RhdHVzICYmIGFwaVJlc3BvbnNlLnN0YXR1cyA+IDApIHtcbiAgICAgICAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgICAgICAgIG5ldyBFcnJvcihhcGlSZXNwb25zZVtcImVycm9yLXRleHRcIl0pLFxuICAgICAgICAgICAgICBhcGlSZXNwb25zZVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhlcnIsIGFwaVJlc3BvbnNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kVFRTTWVzc2FnZShyZWNpcGllbnQsIG1lc3NhZ2UsIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5tc2cpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFvcHRzKSB7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0ZXh0XCJdID0gbWVzc2FnZTtcbiAgICAgIHRoaXMuX3NlbmRWb2ljZU1lc3NhZ2UoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBcIi90dHMvanNvblwiXG4gICAgICAgIH0sXG4gICAgICAgIG9wdHMsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiByZW1vdmUgd2l0aCBuZXh0IG1ham9yIHZlcnNpb24sIEFQSSBpcyA0MDRcbiAgICovXG4gIHNlbmRUVFNQcm9tcHRXaXRoQ2FwdHVyZShcbiAgICByZWNpcGllbnQsXG4gICAgbWVzc2FnZSxcbiAgICBtYXhEaWdpdHMsXG4gICAgYnllVGV4dCxcbiAgICBvcHRzLFxuICAgIGNhbGxiYWNrXG4gICkge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIGlmICghbWF4RGlnaXRzIHx8IGlzTmFOKG1heERpZ2l0cykgfHwgbWF4RGlnaXRzLmxlbmd0aCA+IDE2KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5tYXhEaWdpdHMpKTtcbiAgICB9IGVsc2UgaWYgKCFieWVUZXh0KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5ieWVUZXh0KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghb3B0cykge1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widGV4dFwiXSA9IG1lc3NhZ2U7XG4gICAgICBvcHRzW1wibWF4X2RpZ2l0c1wiXSA9IG1heERpZ2l0cztcbiAgICAgIG9wdHNbXCJieWVfdGV4dFwiXSA9IGJ5ZVRleHQ7XG4gICAgICB0aGlzLl9zZW5kVm9pY2VNZXNzYWdlKFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogXCIvdHRzLXByb21wdC9qc29uXCJcbiAgICAgICAgfSxcbiAgICAgICAgb3B0cyxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IHJlbW92ZSB3aXRoIG5leHQgbWFqb3IgdmVyc2lvbiwgQVBJIGlzIDQwNFxuICAgKi9cbiAgc2VuZFRUU1Byb21wdFdpdGhDb25maXJtKFxuICAgIHJlY2lwaWVudCxcbiAgICBtZXNzYWdlLFxuICAgIG1heERpZ2l0cyxcbiAgICBwaW5Db2RlLFxuICAgIGJ5ZVRleHQsXG4gICAgZmFpbGVkVGV4dCxcbiAgICBvcHRzLFxuICAgIGNhbGxiYWNrXG4gICkge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIGlmICghbWF4RGlnaXRzIHx8IGlzTmFOKG1heERpZ2l0cykgfHwgbWF4RGlnaXRzLmxlbmd0aCA+IDE2KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5tYXhEaWdpdHMpKTtcbiAgICB9IGVsc2UgaWYgKCFwaW5Db2RlIHx8IHBpbkNvZGUubGVuZ3RoICE9PSBtYXhEaWdpdHMpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLnBpbkNvZGUpKTtcbiAgICB9IGVsc2UgaWYgKCFieWVUZXh0KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5ieWVUZXh0KSk7XG4gICAgfSBlbHNlIGlmICghZmFpbGVkVGV4dCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMuZmFpbGVkVGV4dCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIW9wdHMpIHtcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInRleHRcIl0gPSBtZXNzYWdlO1xuICAgICAgb3B0c1tcIm1heF9kaWdpdHNcIl0gPSBtYXhEaWdpdHM7XG4gICAgICBvcHRzW1wicGluX2NvZGVcIl0gPSBwaW5Db2RlO1xuICAgICAgb3B0c1tcImJ5ZV90ZXh0XCJdID0gYnllVGV4dDtcbiAgICAgIG9wdHNbXCJmYWlsZWRfdGV4dFwiXSA9IGZhaWxlZFRleHQ7XG4gICAgICB0aGlzLl9zZW5kVm9pY2VNZXNzYWdlKFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogXCIvdHRzLXByb21wdC9qc29uXCJcbiAgICAgICAgfSxcbiAgICAgICAgb3B0cyxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IHJlbW92ZSB3aXRoIG5leHQgbWFqb3IgdmVyc2lvbiwgQVBJIGlzIDQwNFxuICAgKi9cbiAgY2FsbChyZWNpcGllbnQsIGFuc3dlclVybCwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWFuc3dlclVybCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMuYW5zd2VyVXJsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghb3B0cykge1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1wiYW5zd2VyX3VybFwiXSA9IGFuc3dlclVybDtcbiAgICAgIHRoaXMuX3NlbmRWb2ljZU1lc3NhZ2UoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMucmVzdEhvc3QgfHwgXCJyZXN0Lm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IFwiL2NhbGwvanNvblwiXG4gICAgICAgIH0sXG4gICAgICAgIG9wdHMsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBWb2ljZTtcbiJdfQ==