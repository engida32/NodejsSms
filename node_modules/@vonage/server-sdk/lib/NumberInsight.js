"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class NumberInsight {
  static get PATH() {
    return "/ni/{type}/json";
  }

  static get ERROR_MESSAGES() {
    return {
      numberInsightAdvancedValidation: "Missing Mandatory fields (number and/or callback url)",
      numberInsightValidation: "Missing Mandatory field - number",
      numberInsightPatternFailure: "Number can contain digits and may include any or all of the following: white space, -,+, (, )."
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition NumberInsight options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }
  /**
   * Get insight on the provided number.
   *
   * @param {Object} options - The options for Number Insight
   * @param {string} options.level - the level of insight: 'basic', 'standard'
   *                 or 'advanced'.
   *                 If no `level` value is provided, or an unrecognised value
   *                 is used, 'basic' level insight will be used.
   * @param {string} options.number - the phone number to retrieve insight on
   * @param {string} options.country - 'basic' and 'standard' only.
   *                 An ISO 3166 Alpha 2 country code
   *                 https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
   * @param {string} options. ip - 'advanced' only.
   *                 The IP address in IPv4 notation of the endpoint the
   *                 user connected from.
   * @param {Array}  options.features - 'advanced' only.
   *                 An Array detailing the information you want for this phone
   *                 number. Possible Array elements are:
   *                 - type: number is one of the following: mobile, landline,
   *                          landline_premium or unknown phone number.
   *                 - valid: number exists.
   *                 - reachable: is number available now.
   *                 - carrier: the MCCMNC for the carrier number is registered
   *                             with. This is either: <ISO country code>-FIXED
   *                             or <ISO country code>-PREMIUM.
   *                 - ported: if the user has changed carrier for number.
   *                 - roaming: the subscriber is outside their home network
   *
   * @param {string} options.callback - 'advanced' only.
   *                 The callback to be called when the API call completes.
   * @param {Number} options.callback_timeout - 'advanced' only.
   *                 The maximum wait until the Number Insight Return Parameters
   *                 are sent to callback. This is a value between 1000 - 30000ms
   *                 inclusive. The default is 30000 ms.
   * @param {string} options.callback_method - 'advanced' only.
   *                 The HTTP method used to send the Number Insight Return
   *                 Parameters to callback. Must be GET or POST. The default
   *                 value is GET.
   * @param {string} options.client_ref - 'advanced' only.
   *                 A 40 character reference string returned in the Number
   *                 Insight Return Parameters. This may be useful for your
   *                 internal reports.
   * @param {string} options['include-intermediate-callbacks'] - 'advanced' only.
   *                 Tells the Vonage platform to make callbacks as soon as an
   *                 individual piece of information is retrieved.
   */


  get(options, callback) {
    var level = options.level; // remove 'level' as it's a library-only parameter

    delete options.level;

    if (level === "advanced" || level === "advancedAsync") {
      if (level === "advanced") {
        console.warn('DEPRECATION WARNING: Number Insight Advanced with a level of "advanced" will be synchronous in v2.0+. Consider using the level "advancedAsync" to keep using the async option.');
      }

      this._numberInsightAsync(options, callback);
    } else if (level === "advancedSync") {
      this._numberInsightCommon("advanced", options, callback);
    } else if (level === "standard") {
      this._numberInsightCommon("standard", options, callback);
    } else {
      this._numberInsightCommon("basic", options, callback);
    }
  }

  _numberInsightAsync(inputParams, callback) {
    if (!inputParams.number || !inputParams.callback) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightAdvancedValidation));
    } else {
      inputParams["api_key"] = this.creds.apiKey;
      inputParams["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(NumberInsight.PATH.replace("{type}", "advanced/async")), inputParams)
      }, callback);
    }
  }

  _numberInsightCommon(type, inputParams, callback) {
    if (this._validateNumber(inputParams, callback)) {
      var inputObj;

      if (typeof inputParams !== "object") {
        inputObj = {
          number: inputParams
        };
      } else {
        inputObj = inputParams;
      }

      inputObj["api_key"] = this.creds.apiKey;
      inputObj["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(NumberInsight.PATH.replace("{type}", type)), inputObj)
      }, callback);
    }
  }

  _validateNumber(inputParams, callback) {
    var numberPattern = new RegExp("^[0-9 +()-]*$");

    if (typeof inputParams === "object" && !inputParams.number) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightValidation));
    } else if (typeof inputParams === "object" && !numberPattern.test(inputParams.number)) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightPatternFailure));
    } else if (typeof inputParams !== "object" && (!inputParams || !numberPattern.test(inputParams))) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightPatternFailure));
    }

    return true;
  }

}

var _default = NumberInsight;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OdW1iZXJJbnNpZ2h0LmpzIl0sIm5hbWVzIjpbIk51bWJlckluc2lnaHQiLCJQQVRIIiwiRVJST1JfTUVTU0FHRVMiLCJudW1iZXJJbnNpZ2h0QWR2YW5jZWRWYWxpZGF0aW9uIiwibnVtYmVySW5zaWdodFZhbGlkYXRpb24iLCJudW1iZXJJbnNpZ2h0UGF0dGVybkZhaWx1cmUiLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiZ2V0IiwiY2FsbGJhY2siLCJsZXZlbCIsImNvbnNvbGUiLCJ3YXJuIiwiX251bWJlckluc2lnaHRBc3luYyIsIl9udW1iZXJJbnNpZ2h0Q29tbW9uIiwiaW5wdXRQYXJhbXMiLCJudW1iZXIiLCJVdGlscyIsInNlbmRFcnJvciIsIkVycm9yIiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwiaHR0cENsaWVudCIsInJlcXVlc3QiLCJob3N0IiwiYXBpSG9zdCIsInBhdGgiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwicmVwbGFjZSIsInR5cGUiLCJfdmFsaWRhdGVOdW1iZXIiLCJpbnB1dE9iaiIsIm51bWJlclBhdHRlcm4iLCJSZWdFeHAiLCJ0ZXN0Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOzs7O0FBRUEsTUFBTUEsYUFBTixDQUFvQjtBQUNsQixhQUFXQyxJQUFYLEdBQWtCO0FBQ2hCLFdBQU8saUJBQVA7QUFDRDs7QUFFRCxhQUFXQyxjQUFYLEdBQTRCO0FBQzFCLFdBQU87QUFDTEMsTUFBQUEsK0JBQStCLEVBQzdCLHVEQUZHO0FBR0xDLE1BQUFBLHVCQUF1QixFQUFFLGtDQUhwQjtBQUlMQyxNQUFBQSwyQkFBMkIsRUFDekI7QUFMRyxLQUFQO0FBT0Q7QUFDRDtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUNFQyxFQUFBQSxXQUFXLENBQUNDLFdBQUQsRUFBNEI7QUFBQSxRQUFkQyxPQUFjLHVFQUFKLEVBQUk7QUFDckMsU0FBS0MsS0FBTCxHQUFhRixXQUFiO0FB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QUosQ0FBVXJCLGFBQWEsQ0FBQ0UsY0FBZCxDQUE2QkcsMkJBQXZDLENBRkY7QUFJRDs7QUFDRCxXQUFPLElBQVA7QUFDRDs7QUFyS2lCOztlQXdLTEwsYSIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuY2xhc3MgTnVtYmVySW5zaWdodCB7XG4gIHN0YXRpYyBnZXQgUEFUSCgpIHtcbiAgICByZXR1cm4gXCIvbmkve3R5cGV9L2pzb25cIjtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgRVJST1JfTUVTU0FHRVMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG51bWJlckluc2lnaHRBZHZhbmNlZFZhbGlkYXRpb246XG4gICAgICAgIFwiTWlzc2luZyBNYW5kYXRvcnkgZmllbGRzIChudW1iZXIgYW5kL29yIGNhbGxiYWNrIHVybClcIixcbiAgICAgIG51bWJlckluc2lnaHRWYWxpZGF0aW9uOiBcIk1pc3NpbmcgTWFuZGF0b3J5IGZpZWxkIC0gbnVtYmVyXCIsXG4gICAgICBudW1iZXJJbnNpZ2h0UGF0dGVybkZhaWx1cmU6XG4gICAgICAgIFwiTnVtYmVyIGNhbiBjb250YWluIGRpZ2l0cyBhbmQgbWF5IGluY2x1ZGUgYW55IG9yIGFsbCBvZiB0aGUgZm9sbG93aW5nOiB3aGl0ZSBzcGFjZSwgLSwrLCAoLCApLlwiXG4gICAgfTtcbiAgfVxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gTnVtYmVySW5zaWdodCBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBpbnNpZ2h0IG9uIHRoZSBwcm92aWRlZCBudW1iZXIuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIG9wdGlvbnMgZm9yIE51bWJlciBJbnNpZ2h0XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmxldmVsIC0gdGhlIGxldmVsIG9mIGluc2lnaHQ6ICdiYXNpYycsICdzdGFuZGFyZCdcbiAgICogICAgICAgICAgICAgICAgIG9yICdhZHZhbmNlZCcuXG4gICAqICAgICAgICAgICAgICAgICBJZiBubyBgbGV2ZWxgIHZhbHVlIGlzIHByb3ZpZGVkLCBvciBhbiB1bnJlY29nbmlzZWQgdmFsdWVcbiAgICogICAgICAgICAgICAgICAgIGlzIHVzZWQsICdiYXNpYycgbGV2ZWwgaW5zaWdodCB3aWxsIGJlIHVzZWQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLm51bWJlciAtIHRoZSBwaG9uZSBudW1iZXIgdG8gcmV0cmlldmUgaW5zaWdodCBvblxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5jb3VudHJ5IC0gJ2Jhc2ljJyBhbmQgJ3N0YW5kYXJkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgQW4gSVNPIDMxNjYgQWxwaGEgMiBjb3VudHJ5IGNvZGVcbiAgICogICAgICAgICAgICAgICAgIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0lTT18zMTY2LTFfYWxwaGEtMlxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy4gaXAgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBUaGUgSVAgYWRkcmVzcyBpbiBJUHY0IG5vdGF0aW9uIG9mIHRoZSBlbmRwb2ludCB0aGVcbiAgICogICAgICAgICAgICAgICAgIHVzZXIgY29ubmVjdGVkIGZyb20uXG4gICAqIEBwYXJhbSB7QXJyYXl9ICBvcHRpb25zLmZlYXR1cmVzIC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgQW4gQXJyYXkgZGV0YWlsaW5nIHRoZSBpbmZvcm1hdGlvbiB5b3Ugd2FudCBmb3IgdGhpcyBwaG9uZVxuICAgKiAgICAgICAgICAgICAgICAgbnVtYmVyLiBQb3NzaWJsZSBBcnJheSBlbGVtZW50cyBhcmU6XG4gICAqICAgICAgICAgICAgICAgICAtIHR5cGU6IG51bWJlciBpcyBvbmUgb2YgdGhlIGZvbGxvd2luZzogbW9iaWxlLCBsYW5kbGluZSxcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgIGxhbmRsaW5lX3ByZW1pdW0gb3IgdW5rbm93biBwaG9uZSBudW1iZXIuXG4gICAqICAgICAgICAgICAgICAgICAtIHZhbGlkOiBudW1iZXIgZXhpc3RzLlxuICAgKiAgICAgICAgICAgICAgICAgLSByZWFjaGFibGU6IGlzIG51bWJlciBhdmFpbGFibGUgbm93LlxuICAgKiAgICAgICAgICAgICAgICAgLSBjYXJyaWVyOiB0aGUgTUNDTU5DIGZvciB0aGUgY2FycmllciBudW1iZXIgaXMgcmVnaXN0ZXJlZFxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aC4gVGhpcyBpcyBlaXRoZXI6IDxJU08gY291bnRyeSBjb2RlPi1GSVhFRFxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3IgPElTTyBjb3VudHJ5IGNvZGU+LVBSRU1JVU0uXG4gICAqICAgICAgICAgICAgICAgICAtIHBvcnRlZDogaWYgdGhlIHVzZXIgaGFzIGNoYW5nZWQgY2FycmllciBmb3IgbnVtYmVyLlxuICAgKiAgICAgICAgICAgICAgICAgLSByb2FtaW5nOiB0aGUgc3Vic2NyaWJlciBpcyBvdXRzaWRlIHRoZWlyIGhvbWUgbmV0d29ya1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5jYWxsYmFjayAtICdhZHZhbmNlZCcgb25seS5cbiAgICogICAgICAgICAgICAgICAgIFRoZSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiB0aGUgQVBJIGNhbGwgY29tcGxldGVzLlxuICAgKiBAcGFyYW0ge051bWJlcn0gb3B0aW9ucy5jYWxsYmFja190aW1lb3V0IC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgVGhlIG1heGltdW0gd2FpdCB1bnRpbCB0aGUgTnVtYmVyIEluc2lnaHQgUmV0dXJuIFBhcmFtZXRlcnNcbiAgICogICAgICAgICAgICAgICAgIGFyZSBzZW50IHRvIGNhbGxiYWNrLiBUaGlzIGlzIGEgdmFsdWUgYmV0d2VlbiAxMDAwIC0gMzAwMDBtc1xuICAgKiAgICAgICAgICAgICAgICAgaW5jbHVzaXZlLiBUaGUgZGVmYXVsdCBpcyAzMDAwMCBtcy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMuY2FsbGJhY2tfbWV0aG9kIC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgVGhlIEhUVFAgbWV0aG9kIHVzZWQgdG8gc2VuZCB0aGUgTnVtYmVyIEluc2lnaHQgUmV0dXJuXG4gICAqICAgICAgICAgICAgICAgICBQYXJhbWV0ZXJzIHRvIGNhbGxiYWNrLiBNdXN0IGJlIEdFVCBvciBQT1NULiBUaGUgZGVmYXVsdFxuICAgKiAgICAgICAgICAgICAgICAgdmFsdWUgaXMgR0VULlxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5jbGllbnRfcmVmIC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgQSA0MCBjaGFyYWN0ZXIgcmVmZXJlbmNlIHN0cmluZyByZXR1cm5lZCBpbiB0aGUgTnVtYmVyXG4gICAqICAgICAgICAgICAgICAgICBJbnNpZ2h0IFJldHVybiBQYXJhbWV0ZXJzLiBUaGlzIG1heSBiZSB1c2VmdWwgZm9yIHlvdXJcbiAgICogICAgICAgICAgICAgICAgIGludGVybmFsIHJlcG9ydHMuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zWydpbmNsdWRlLWludGVybWVkaWF0ZS1jYWxsYmFja3MnXSAtICdhZHZhbmNlZCcgb25seS5cbiAgICogICAgICAgICAgICAgICAgIFRlbGxzIHRoZSBWb25hZ2UgcGxhdGZvcm0gdG8gbWFrZSBjYWxsYmFja3MgYXMgc29vbiBhcyBhblxuICAgKiAgICAgICAgICAgICAgICAgaW5kaXZpZHVhbCBwaWVjZSBvZiBpbmZvcm1hdGlvbiBpcyByZXRyaWV2ZWQuXG4gICAqL1xuICBnZXQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICB2YXIgbGV2ZWwgPSBvcHRpb25zLmxldmVsO1xuICAgIC8vIHJlbW92ZSAnbGV2ZWwnIGFzIGl0J3MgYSBsaWJyYXJ5LW9ubHkgcGFyYW1ldGVyXG4gICAgZGVsZXRlIG9wdGlvbnMubGV2ZWw7XG5cbiAgICBpZiAobGV2ZWwgPT09IFwiYWR2YW5jZWRcIiB8fCBsZXZlbCA9PT0gXCJhZHZhbmNlZEFzeW5jXCIpIHtcbiAgICAgIGlmIChsZXZlbCA9PT0gXCJhZHZhbmNlZFwiKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAnREVQUkVDQVRJT04gV0FSTklORzogTnVtYmVyIEluc2lnaHQgQWR2YW5jZWQgd2l0aCBhIGxldmVsIG9mIFwiYWR2YW5jZWRcIiB3aWxsIGJlIHN5bmNocm9ub3VzIGluIHYyLjArLiBDb25zaWRlciB1c2luZyB0aGUgbGV2ZWwgXCJhZHZhbmNlZEFzeW5jXCIgdG8ga2VlcCB1c2luZyB0aGUgYXN5bmMgb3B0aW9uLidcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX251bWJlckluc2lnaHRBc3luYyhvcHRpb25zLCBjYWxsYmFjayk7XG4gICAgfSBlbHNlIGlmIChsZXZlbCA9PT0gXCJhZHZhbmNlZFN5bmNcIikge1xuICAgICAgdGhpcy5fbnVtYmVySW5zaWdodENvbW1vbihcImFkdmFuY2VkXCIsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbiAgICB9IGVsc2UgaWYgKGxldmVsID09PSBcInN0YW5kYXJkXCIpIHtcbiAgICAgIHRoaXMuX251bWJlckluc2lnaHRDb21tb24oXCJzdGFuZGFyZFwiLCBvcHRpb25zLCBjYWxsYmFjayk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX251bWJlckluc2lnaHRDb21tb24oXCJiYXNpY1wiLCBvcHRpb25zLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgX251bWJlckluc2lnaHRBc3luYyhpbnB1dFBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWlucHV0UGFyYW1zLm51bWJlciB8fCAhaW5wdXRQYXJhbXMuY2FsbGJhY2spIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5ldyBFcnJvcihOdW1iZXJJbnNpZ2h0LkVSUk9SX01FU1NBR0VTLm51bWJlckluc2lnaHRBZHZhbmNlZFZhbGlkYXRpb24pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbnB1dFBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRzLmFwaUtleTtcbiAgICAgIGlucHV0UGFyYW1zW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZHMuYXBpU2VjcmV0O1xuICAgICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoXG4gICAgICAgICAgICBgJHtOdW1iZXJJbnNpZ2h0LlBBVEgucmVwbGFjZShcInt0eXBlfVwiLCBcImFkdmFuY2VkL2FzeW5jXCIpfWAsXG4gICAgICAgICAgICBpbnB1dFBhcmFtc1xuICAgICAgICAgIClcbiAgICAgICAgfSxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgX251bWJlckluc2lnaHRDb21tb24odHlwZSwgaW5wdXRQYXJhbXMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHRoaXMuX3ZhbGlkYXRlTnVtYmVyKGlucHV0UGFyYW1zLCBjYWxsYmFjaykpIHtcbiAgICAgIHZhciBpbnB1dE9iajtcbiAgICAgIGlmICh0eXBlb2YgaW5wdXRQYXJhbXMgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgaW5wdXRPYmogPSB7XG4gICAgICAgICAgbnVtYmVyOiBpbnB1dFBhcmFtc1xuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5wdXRPYmogPSBpbnB1dFBhcmFtcztcbiAgICAgIH1cbiAgICAgIGlucHV0T2JqW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZHMuYXBpS2V5O1xuICAgICAgaW5wdXRPYmpbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkcy5hcGlTZWNyZXQ7XG4gICAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShcbiAgICAgICAgICAgIGAke051bWJlckluc2lnaHQuUEFUSC5yZXBsYWNlKFwie3R5cGV9XCIsIHR5cGUpfWAsXG4gICAgICAgICAgICBpbnB1dE9ialxuICAgICAgICAgIClcbiAgICAgICAgfSxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgX3ZhbGlkYXRlTnVtYmVyKGlucHV0UGFyYW1zLCBjYWxsYmFjaykge1xuICAgIHZhciBudW1iZXJQYXR0ZXJuID0gbmV3IFJlZ0V4cChcIl5bMC05ICsoKS1dKiRcIik7XG5cbiAgICBpZiAodHlwZW9mIGlucHV0UGFyYW1zID09PSBcIm9iamVjdFwiICYmICFpbnB1dFBhcmFtcy5udW1iZXIpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5ldyBFcnJvcihOdW1iZXJJbnNpZ2h0LkVSUk9SX01FU1NBR0VTLm51bWJlckluc2lnaHRWYWxpZGF0aW9uKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgdHlwZW9mIGlucHV0UGFyYW1zID09PSBcIm9iamVjdFwiICYmXG4gICAgICAhbnVtYmVyUGF0dGVybi50ZXN0KGlucHV0UGFyYW1zLm51bWJlcilcbiAgICApIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5ldyBFcnJvcihOdW1iZXJJbnNpZ2h0LkVSUk9SX01FU1NBR0VTLm51bWJlckluc2lnaHRQYXR0ZXJuRmFpbHVyZSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHR5cGVvZiBpbnB1dFBhcmFtcyAhPT0gXCJvYmplY3RcIiAmJlxuICAgICAgKCFpbnB1dFBhcmFtcyB8fCAhbnVtYmVyUGF0dGVybi50ZXN0KGlucHV0UGFyYW1zKSlcbiAgICApIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5ldyBFcnJvcihOdW1iZXJJbnNpZ2h0LkVSUk9SX01FU1NBR0VTLm51bWJlckluc2lnaHRQYXR0ZXJuRmFpbHVyZSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE51bWJlckluc2lnaHQ7XG4iXX0=