"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _JwtGenerator = _interopRequireDefault(require("./JwtGenerator"));

var _HashGenerator = _interopRequireDefault(require("./HashGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Right now only key/secret credentials are supported.
 * However, in time JWT will also be supported.
 * The `Credentials` object provides an abstraction to this.
 *
 * @param {string} apiKey - A Vonage API Key
 * @param {string} apiSecret - A Vonage API Secret
 * @param {string} [applicationId] - A VonageApplication ID
 * @param {string|Buffer} [privateKey] -  When a string value is passed it should
 *                        either represent the path to the private key, or the actual
 *                        private key in string format. If a Buffer is passed then
 *                        it should be the key read from the file system.
 * @param {string} [signatureSecret] - A Vonage signature Secret
 * @param {string} [signatureMethod] - A Vonage compatible request signing method
 */
class Credentials {
  constructor(apiKey, apiSecret, privateKey, applicationId, signatureSecret, signatureMethod) {
    this.apiKey = apiKey;
    this.apiSecret = apiSecret;
    this.privateKey = null;
    this.applicationId = applicationId;
    this.signatureSecret = signatureSecret;
    this.signatureMethod = signatureMethod;

    if (privateKey instanceof Buffer) {
      // it is already a buffer, use it as-is
      this.privateKey = privateKey;
    } else if (typeof privateKey === "string" && privateKey.startsWith("-----BEGIN PRIVATE KEY-----")) {
      // It's a key string. Check for \n, replace with newlines
      privateKey = privateKey.replace(/\\n/g, "\n");
      this.privateKey = Buffer.from(privateKey, "utf-8");
    } else if (privateKey !== undefined) {
      if (!_fs.default.existsSync(privateKey)) {
        throw new Error("File \"".concat(privateKey, "\" not found."));
      }

      this.privateKey = _fs.default.readFileSync(privateKey);
    }
    /** @private */


    this._jwtGenerator = new _JwtGenerator.default();
    this._hashGenerator = new _HashGenerator.default();
  }
  /**
   * Generate a Jwt using the Private Key in the Credentials.
   * By default the credentials.applicationId will be used when creating the token.
   * However, this can be overwritten.
   *
   * @param {string} [applicationId] an application ID to be used instead of the
   *                default Credentials.applicationId value.
   *
   * @returns {string} The generated JWT
   */


  generateJwt() {
    var applicationId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.applicationId;
    var privateKey = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.privateKey;
    var claims = {
      application_id: applicationId
    };

    var token = this._jwtGenerator.generate(privateKey, claims);

    return token;
  }

  generateSignature(params) {
    var signatureSecret = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.signatureSecret;
    var signatureMethod = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.signatureMethod;
    return this._hashGenerator.generate(signatureMethod, signatureSecret, params);
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setJwtGenerator(generator) {
    this._jwtGenerator = generator;
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setHashGenerator(generator) {
    this._hashGenerator = generator;
  }
  /**
   * Ensures a credentials instance is used.
   *
   * Key/Secret credentials are only supported at present.
   */


  static parse(obj) {
    if (obj instanceof Credentials) {
      return obj;
    } else {
      return new Credentials(obj.apiKey, obj.apiSecret, obj.privateKey, obj.applicationId, obj.signatureSecret, obj.signatureMethod);
    }
  }

}

var _default = Credentials;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9DcmVkZW50aWFscy5qcyJdLCJuYW1lcyI6WyJDcmVkZW50aWFscyIsImNvbnN0cnVjdG9yIiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwicHJpdmF0ZUtleSIsImFwcGxpY2F0aW9uSWQiLCJzaWduYXR1cmVTZWNyZXQiLCJzaWduYXR1cmVNZXRob2QiLCJCdWZmZXIiLCJzdGFydHNXaXRoIiwicmVwbGFjZSIsImZyb20iLCJ1bmRlZmluZWQiLCJmcyIsImV4aXN0c1N5bmMiLCJFcnJvciIsInJlYWRGaWxlU3luYyIsIl9qd3RHZW5lcmF0b3IiLCJKd3RHZW5lcmF0b3IiLCJfaGFzaEdlbmVyYXRvciIsIkhhc2hHZW5lcmF0b3IiLCJnZW5lcmF0ZUp3dCIsImNsYWltcyIsImFwcGxpY2F0aW9uX2lkIiwidG9rZW4iLCJnZW5lcmF0ZSIsImdlbmVyYXRlU2lnbmF0dXJlIiwicGFyYW1zIiwiX3NldEp3dEdlbmVyYXRvciIsImdlbmVyYXRvciIsIl9zZXRIYXNoR2VuZXJhdG9yIiwicGFyc2UiLCJvYmoiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSxXQUFOLENBQWtCO0FBQ2hCQyxFQUFBQSxXQUFXLENBQ1RDLE1BRFMsRUFFVEMsU0FGUyxFQUdUQyxVQUhTLEVBSVRDLGFBSlMsRUFLVEMsZUFMUyxFQU1UQyxlQU5TLEVBT1Q7QUFDQSxTQUFLTCxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxTQUFMLEdBQWlCQSxTQUFqQjtBQUVBLFNBQUtDLFVBQUwsR0FBa0IsSUFBbEI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCQSxhQUFyQjtBQUVBLFNBQUtDLGVBQUwsR0FBdUJBLGVBQXZCO0FBQ0EsU0FBS0MsZUFBTCxHQUF1QkEsZUFBdkI7O0FBRUEsUUFBSUgsVUFBVSxZQUFZSSxNQUExQixFQUFrQztBQUNoQztBQUNBLFdBQUtKLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0QsS0FIRCxNQUdPLElBQ0wsT0FBT0EsVUFBUCxLQUFzQixRQUF0QixJQUNBQSxVQUFVLENBQUNLLFVBQVgsQ0FBc0IsNkJBQXRCLENBRkssRUFHTDtBQUNBO0FBQ0FMLE1BQUFBLFVBQVUsR0FBR0EsVUFBVSxDQUFDTSxPQUFYLENBQW1CLE1BQW5CLEVBQTJCLElBQTNCLENBQWI7QUFDQSxXQUFLTixVQUFMLEdBQWtCSSxNQUFNLENBQUNHLElBQVAsQ0FBWVAsVUFBWixFQUF3QixPQUF4QixDQUFsQjtBQUNELEtBUE0sTUFPQSxJQUFJQSxVQUFVLEtBQUtRLFNBQW5CLEVBQThCO0FBQ25DLFVBQUksQ0FBQ0MsWUFBR0MsVUFBSCxDQUFjVixVQUFkLENBQUwsRUFBZ0M7QUFDOUIsY0FBTSxJQUFJVyxLQUFKLGtCQUFtQlgsVUFBbkIsbUJBQU47QUFDRDs7QUFDRCxXQUFLQSxVQUFMLEdBQWtCUyxZQUFHRyxZQUFILENBQWdCWixVQUFoQixDQUFsQjtBQUNEO0FBRUQ7OztBQUNBLFNBQUthLGFBQUwsR0FBcUIsSUFBSUMscUJBQUosRUFBckI7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLElBQUlDLHNCQUFKLEVBQXRCO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0VDLEVBQUFBLFdBQVcsR0FHVDtBQUFBLFFBRkFoQixhQUVBLHVFQUZnQixLQUFLQSxhQUVyQjtBQUFBLFFBREFELFVBQ0EsdUVBRGEsS0FBS0EsVUFDbEI7QUFDQSxRQUFJa0IsTUFBTSxHQUFHO0FBQ1hDLE1BQUFBLGNBQWMsRUFBRWxCO0FBREwsS0FBYjs7QUFHQSxRQUFJbUIsS0FBSyxHQUFHLEtBQUtQLGFBQUwsQ0FBbUJRLFFBQW5CLENBQTRCckIsVUFBNUIsRUFBd0NrQixNQUF4QyxDQUFaOztBQUNBLFdBQU9FLEtBQVA7QUFDRDs7QUFFREUsRUFBQUEsaUJBQWlCLENBQ2ZDLE1BRGUsRUFJZjtBQUFBLFFBRkFyQixlQUVBLHVFQUZrQixLQUFLQSxlQUV2QjtBQUFBLFFBREFDLGVBQ0EsdUVBRGtCLEtBQUtBLGVBQ3ZCO0FBQ0EsV0FBTyxLQUFLWSxjQUFMLENBQW9CTSxRQUFwQixDQUNMbEIsZUFESyxFQUVMRCxlQUZLLEVBR0xxQixNQUhLLENBQVA7QUFLRDtBQUVEO0FBQ0Y7QUFDQTtBQUNBOzs7QUFDRUMsRUFBQUEsZ0JBQWdCLENBQUNDLFNBQUQsRUFBWTtBQUMxQixTQUFLWixhQUFMLEdBQXFCWSxTQUFyQjtBQUNEO0FBRUQ7QUFDRjtBQUNBO0FBQ0E7OztBQUNFQyxFQUFBQSxpQkFBaUIsQ0FBQ0QsU0FBRCxFQUFZO0FBQzNCLFNBQUtWLGNBQUwsR0FBc0JVLFNBQXRCO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBOzs7QUFDRSxTQUFPRSxLQUFQLENBQWFDLEdBQWIsRUFBa0I7QUFDaEIsUUFBSUEsR0FBRyxZQUFZaEMsV0FBbkIsRUFBZ0M7QUFDOUIsYUFBT2dDLEdBQVA7QUFDRCxLQUZELE1BRU87QUFDTCxhQUFPLElBQUloQyxXQUFKLENBQ0xnQyxHQUFHLENBQUM5QixNQURDLEVBRUw4QixHQUFHLENBQUM3QixTQUZDLEVBR0w2QixHQUFHLENBQUM1QixVQUhDLEVBSUw0QixHQUFHLENBQUMzQixhQUpDLEVBS0wyQixHQUFHLENBQUMxQixlQUxDLEVBTUwwQixHQUFHLENBQUN6QixlQU5DLENBQVA7QUFRRDtBQUNGOztBQTNHZTs7ZUE4R0hQLFciLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IEp3dEdlbmVyYXRvciBmcm9tIFwiLi9Kd3RHZW5lcmF0b3JcIjtcbmltcG9ydCBIYXNoR2VuZXJhdG9yIGZyb20gXCIuL0hhc2hHZW5lcmF0b3JcIjtcblxuLyoqXG4gKiBSaWdodCBub3cgb25seSBrZXkvc2VjcmV0IGNyZWRlbnRpYWxzIGFyZSBzdXBwb3J0ZWQuXG4gKiBIb3dldmVyLCBpbiB0aW1lIEpXVCB3aWxsIGFsc28gYmUgc3VwcG9ydGVkLlxuICogVGhlIGBDcmVkZW50aWFsc2Agb2JqZWN0IHByb3ZpZGVzIGFuIGFic3RyYWN0aW9uIHRvIHRoaXMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwaUtleSAtIEEgVm9uYWdlIEFQSSBLZXlcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGlTZWNyZXQgLSBBIFZvbmFnZSBBUEkgU2VjcmV0XG4gKiBAcGFyYW0ge3N0cmluZ30gW2FwcGxpY2F0aW9uSWRdIC0gQSBWb25hZ2VBcHBsaWNhdGlvbiBJRFxuICogQHBhcmFtIHtzdHJpbmd8QnVmZmVyfSBbcHJpdmF0ZUtleV0gLSAgV2hlbiBhIHN0cmluZyB2YWx1ZSBpcyBwYXNzZWQgaXQgc2hvdWxkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIGVpdGhlciByZXByZXNlbnQgdGhlIHBhdGggdG8gdGhlIHByaXZhdGUga2V5LCBvciB0aGUgYWN0dWFsXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIHByaXZhdGUga2V5IGluIHN0cmluZyBmb3JtYXQuIElmIGEgQnVmZmVyIGlzIHBhc3NlZCB0aGVuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIGl0IHNob3VsZCBiZSB0aGUga2V5IHJlYWQgZnJvbSB0aGUgZmlsZSBzeXN0ZW0uXG4gKiBAcGFyYW0ge3N0cmluZ30gW3NpZ25hdHVyZVNlY3JldF0gLSBBIFZvbmFnZSBzaWduYXR1cmUgU2VjcmV0XG4gKiBAcGFyYW0ge3N0cmluZ30gW3NpZ25hdHVyZU1ldGhvZF0gLSBBIFZvbmFnZSBjb21wYXRpYmxlIHJlcXVlc3Qgc2lnbmluZyBtZXRob2RcbiAqL1xuY2xhc3MgQ3JlZGVudGlhbHMge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhcGlLZXksXG4gICAgYXBpU2VjcmV0LFxuICAgIHByaXZhdGVLZXksXG4gICAgYXBwbGljYXRpb25JZCxcbiAgICBzaWduYXR1cmVTZWNyZXQsXG4gICAgc2lnbmF0dXJlTWV0aG9kXG4gICkge1xuICAgIHRoaXMuYXBpS2V5ID0gYXBpS2V5O1xuICAgIHRoaXMuYXBpU2VjcmV0ID0gYXBpU2VjcmV0O1xuXG4gICAgdGhpcy5wcml2YXRlS2V5ID0gbnVsbDtcbiAgICB0aGlzLmFwcGxpY2F0aW9uSWQgPSBhcHBsaWNhdGlvbklkO1xuXG4gICAgdGhpcy5zaWduYXR1cmVTZWNyZXQgPSBzaWduYXR1cmVTZWNyZXQ7XG4gICAgdGhpcy5zaWduYXR1cmVNZXRob2QgPSBzaWduYXR1cmVNZXRob2Q7XG5cbiAgICBpZiAocHJpdmF0ZUtleSBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgICAgLy8gaXQgaXMgYWxyZWFkeSBhIGJ1ZmZlciwgdXNlIGl0IGFzLWlzXG4gICAgICB0aGlzLnByaXZhdGVLZXkgPSBwcml2YXRlS2V5O1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICB0eXBlb2YgcHJpdmF0ZUtleSA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgcHJpdmF0ZUtleS5zdGFydHNXaXRoKFwiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXCIpXG4gICAgKSB7XG4gICAgICAvLyBJdCdzIGEga2V5IHN0cmluZy4gQ2hlY2sgZm9yIFxcbiwgcmVwbGFjZSB3aXRoIG5ld2xpbmVzXG4gICAgICBwcml2YXRlS2V5ID0gcHJpdmF0ZUtleS5yZXBsYWNlKC9cXFxcbi9nLCBcIlxcblwiKTtcbiAgICAgIHRoaXMucHJpdmF0ZUtleSA9IEJ1ZmZlci5mcm9tKHByaXZhdGVLZXksIFwidXRmLThcIik7XG4gICAgfSBlbHNlIGlmIChwcml2YXRlS2V5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhwcml2YXRlS2V5KSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGUgXCIke3ByaXZhdGVLZXl9XCIgbm90IGZvdW5kLmApO1xuICAgICAgfVxuICAgICAgdGhpcy5wcml2YXRlS2V5ID0gZnMucmVhZEZpbGVTeW5jKHByaXZhdGVLZXkpO1xuICAgIH1cblxuICAgIC8qKiBAcHJpdmF0ZSAqL1xuICAgIHRoaXMuX2p3dEdlbmVyYXRvciA9IG5ldyBKd3RHZW5lcmF0b3IoKTtcbiAgICB0aGlzLl9oYXNoR2VuZXJhdG9yID0gbmV3IEhhc2hHZW5lcmF0b3IoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIEp3dCB1c2luZyB0aGUgUHJpdmF0ZSBLZXkgaW4gdGhlIENyZWRlbnRpYWxzLlxuICAgKiBCeSBkZWZhdWx0IHRoZSBjcmVkZW50aWFscy5hcHBsaWNhdGlvbklkIHdpbGwgYmUgdXNlZCB3aGVuIGNyZWF0aW5nIHRoZSB0b2tlbi5cbiAgICogSG93ZXZlciwgdGhpcyBjYW4gYmUgb3ZlcndyaXR0ZW4uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBbYXBwbGljYXRpb25JZF0gYW4gYXBwbGljYXRpb24gSUQgdG8gYmUgdXNlZCBpbnN0ZWFkIG9mIHRoZVxuICAgKiAgICAgICAgICAgICAgICBkZWZhdWx0IENyZWRlbnRpYWxzLmFwcGxpY2F0aW9uSWQgdmFsdWUuXG4gICAqXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBnZW5lcmF0ZWQgSldUXG4gICAqL1xuICBnZW5lcmF0ZUp3dChcbiAgICBhcHBsaWNhdGlvbklkID0gdGhpcy5hcHBsaWNhdGlvbklkLFxuICAgIHByaXZhdGVLZXkgPSB0aGlzLnByaXZhdGVLZXlcbiAgKSB7XG4gICAgdmFyIGNsYWltcyA9IHtcbiAgICAgIGFwcGxpY2F0aW9uX2lkOiBhcHBsaWNhdGlvbklkXG4gICAgfTtcbiAgICB2YXIgdG9rZW4gPSB0aGlzLl9qd3RHZW5lcmF0b3IuZ2VuZXJhdGUocHJpdmF0ZUtleSwgY2xhaW1zKTtcbiAgICByZXR1cm4gdG9rZW47XG4gIH1cblxuICBnZW5lcmF0ZVNpZ25hdHVyZShcbiAgICBwYXJhbXMsXG4gICAgc2lnbmF0dXJlU2VjcmV0ID0gdGhpcy5zaWduYXR1cmVTZWNyZXQsXG4gICAgc2lnbmF0dXJlTWV0aG9kID0gdGhpcy5zaWduYXR1cmVNZXRob2RcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuX2hhc2hHZW5lcmF0b3IuZ2VuZXJhdGUoXG4gICAgICBzaWduYXR1cmVNZXRob2QsXG4gICAgICBzaWduYXR1cmVTZWNyZXQsXG4gICAgICBwYXJhbXNcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIFVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMgb25seS5cbiAgICovXG4gIF9zZXRKd3RHZW5lcmF0b3IoZ2VuZXJhdG9yKSB7XG4gICAgdGhpcy5fand0R2VuZXJhdG9yID0gZ2VuZXJhdG9yO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIFVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMgb25seS5cbiAgICovXG4gIF9zZXRIYXNoR2VuZXJhdG9yKGdlbmVyYXRvcikge1xuICAgIHRoaXMuX2hhc2hHZW5lcmF0b3IgPSBnZW5lcmF0b3I7XG4gIH1cblxuICAvKipcbiAgICogRW5zdXJlcyBhIGNyZWRlbnRpYWxzIGluc3RhbmNlIGlzIHVzZWQuXG4gICAqXG4gICAqIEtleS9TZWNyZXQgY3JlZGVudGlhbHMgYXJlIG9ubHkgc3VwcG9ydGVkIGF0IHByZXNlbnQuXG4gICAqL1xuICBzdGF0aWMgcGFyc2Uob2JqKSB7XG4gICAgaWYgKG9iaiBpbnN0YW5jZW9mIENyZWRlbnRpYWxzKSB7XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IENyZWRlbnRpYWxzKFxuICAgICAgICBvYmouYXBpS2V5LFxuICAgICAgICBvYmouYXBpU2VjcmV0LFxuICAgICAgICBvYmoucHJpdmF0ZUtleSxcbiAgICAgICAgb2JqLmFwcGxpY2F0aW9uSWQsXG4gICAgICAgIG9iai5zaWduYXR1cmVTZWNyZXQsXG4gICAgICAgIG9iai5zaWduYXR1cmVNZXRob2RcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENyZWRlbnRpYWxzO1xuIl19