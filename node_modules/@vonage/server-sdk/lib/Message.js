"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

var _ShortCode = _interopRequireDefault(require("./ShortCode"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var querystring = require("querystring");

class Message {
  static get ERROR_MESSAGES() {
    return {
      sender: "Invalid from address",
      to: "Invalid to address",
      msg: "Invalid Text Message",
      body: "Invalid Body value in Binary Message",
      udh: "Invalid udh value in Binary Message",
      title: "Invalid title in WAP Push message",
      url: "Invalid url in WAP Push message"
    };
  }

  static get PATH() {
    return "/sms/json";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition SMS options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;

    var _shortcode = new _ShortCode.default(this.creds, this.options);

    this.shortcodeAlert = _shortcode.shortcodeAlert.bind(_shortcode);
    this.shortcode2FA = _shortcode.shortcode2FA.bind(_shortcode);
    this.shortcodeMarketing = _shortcode.shortcodeMarketing.bind(_shortcode);
  }

  _sendRequest(endpoint, method, callback) {
    endpoint.path = endpoint.path + (endpoint.path.indexOf("?") > 0 ? "&" : "?") + querystring.stringify({
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    });
    this.options.httpClient.request(endpoint, method, callback);
  }

  _sendMessage(data, callback) {
    if (!data.from) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.sender));
    } else if (!data.to) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.to));
    } else {
      var path = Message.PATH + "?" + querystring.stringify(data);
      this.options.logger.info("sending message from " + data.from + " to " + data.to + " with message " + data.text);

      this._sendRequest({
        host: this.options.restHost || "rest.nexmo.com",
        path: path
      }, "POST", function (err, apiResponse) {
        if (!err && apiResponse.status && apiResponse.messages[0].status > 0) {
          _Utils.default.sendError(callback, new Error(apiResponse.messages[0]["error-text"]), apiResponse);
        } else {
          if (callback) callback(err, apiResponse);
        }
      });
    }
  }
  /**
   * TODO: document
   */


  sendSms(sender, recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.msg));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["text"] = message;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendBinaryMessage(sender, recipient, body, udh, opts, callback) {
    if (!body) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.body));
    } else if (!udh) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.udh));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "binary";
      opts["body"] = body;
      opts["udh"] = udh;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendWapPushMessage(sender, recipient, title, url, validity, opts, callback) {
    if (!title) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.title));
    } else if (!url) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.url));
    } else {
      if (typeof validity === "function") {
        callback = validity;
        opts = {};
        validity = 86400000;
      }

      if (typeof opts === "function") {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "wappush";
      opts["title"] = title;
      opts["validity"] = validity;
      opts["url"] = url;

      this._sendMessage(opts, callback);
    }
  }

  search(id, callback) {
    if (typeof id == "string") {
      return this.options.rest.get("/search/message", {
        id: id
      }, callback);
    } // Otherwise we expect an array


    return this.options.rest.get("/search/messages", {
      ids: id
    }, callback);
  }

  searchRejections(to, date, callback) {
    return this.options.rest.get("/search/rejections", {
      to,
      date
    }, callback);
  }

}

var _default = Message;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZXNzYWdlLmpzIl0sIm5hbWVzIjpbInF1ZXJ5c3RyaW5nIiwicmVxdWlyZSIsIk1lc3NhZ2UiLCJFUlJPUl9NRVNTQUdFUyIsInNlbmRlciIsInRvIiwibXNnIiwiYm9keSIsInVkaCIsInRpdGxlIiwidXJsIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfc2hvcnRjb2RlIiwiU2hvcnRDb2RlIiwic2hvcnRjb2RlQWxlcnQiLCJiaW5kIiwic2hvcnRjb2RlMkZBIiwic2hvcnRjb2RlTWFya2V0aW5nIiwiX3NlbmRSZXF1ZXN0IiwiZW5kcG9pbnQiLCJtZXRob2QiLCJjYWxsYmFjayIsInBhdGgiLCJpbmRleE9mIiwic3RyaW5naWZ5IiwiYXBpX2tleSIsImFwaUtleSIsImFwaV9zZWNyZXQiLCJhcGlTZWNyZXQiLCJodHRwQ2xpZW50IiwicmVxdWVzdCIsIl9zZW5kTWVzc2FnZSIsImRhdGEiLCJmcm9tIiwiVXRpbHMiLCJzZW5kRXJyb3IiLCJFcnJvciIsImxvZ2dlciIsImluZm8iLCJ0ZXh0IiwiaG9zdCIsInJlc3RIb3N0IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJtZXNzYWdlcyIsInNlbmRTbXMiLCJyZWNpcGllbnQiLCJtZXNzYWdlIiwib3B0cyIsInNlbmRCaW5hcnlNZXNzYWdlIiwic2VuZFdhcFB1c2hNZXNzYWdlIiwidmFsaWRpdHkiLCJzZWFyY2giLCJpZCIsInJlc3QiLCJnZXQiLCJpZHMiLCJzZWFyY2hSZWplY3Rpb25zIiwiZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFFQTs7OztBQUVBLElBQUlBLFdBQVcsR0FBR0MsT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBRUEsTUFBTUMsT0FBTixDQUFjO0FBQ1osYUFBV0MsY0FBWCxHQUE0QjtBQUMxQixXQUFPO0FBQ0xDLE1BQUFBLE1BQU0sRUFBRSxzQkFESDtBQUVMQyxNQUFBQSxFQUFF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QyxRQUxLLENBQVA7QUFPRCxLQVRrQixDQVduQjs7O0FBQ0EsV0FBTyxLQUFLWCxPQUFMLENBQWE2QyxJQUFiLENBQWtCQyxHQUFsQixDQUNMLGtCQURLLEVBRUw7QUFDRUMsTUFBQUEsR0FBRyxFQUFFSDtBQURQLEtBRkssRUFLTGpDLFFBTEssQ0FBUDtBQU9EOztBQUVEcUMsRUFBQUEsZ0JBQWdCLENBQUN6RCxFQUFELEVBQUswRCxJQUFMLEVBQVd0QyxRQUFYLEVBQXFCO0FBQ25DLFdBQU8sS0FBS1gsT0FBTCxDQUFhNkMsSUFBYixDQUFrQkMsR0FBbEIsQ0FDTCxvQkFESyxFQUVMO0FBQ0V2RCxNQUFBQSxFQURGO0FBRUUwRCxNQUFBQTtBQUZGLEtBRkssRUFNTHRDLFFBTkssQ0FBUDtBQVFEOztBQXZMVzs7ZUEwTEN2QixPIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBVdGlscyBmcm9tIFwiLi9VdGlsc1wiO1xuXG5pbXBvcnQgU2hvcnRDb2RlIGZyb20gXCIuL1Nob3J0Q29kZVwiO1xuXG52YXIgcXVlcnlzdHJpbmcgPSByZXF1aXJlKFwicXVlcnlzdHJpbmdcIik7XG5cbmNsYXNzIE1lc3NhZ2Uge1xuICBzdGF0aWMgZ2V0IEVSUk9SX01FU1NBR0VTKCkge1xuICAgIHJldHVybiB7XG4gICAgICBzZW5kZXI6IFwiSW52YWxpZCBmcm9tIGFkZHJlc3NcIixcbiAgICAgIHRvOiBcIkludmFsaWQgdG8gYWRkcmVzc1wiLFxuICAgICAgbXNnOiBcIkludmFsaWQgVGV4dCBNZXNzYWdlXCIsXG4gICAgICBib2R5OiBcIkludmFsaWQgQm9keSB2YWx1ZSBpbiBCaW5hcnkgTWVzc2FnZVwiLFxuICAgICAgdWRoOiBcIkludmFsaWQgdWRoIHZhbHVlIGluIEJpbmFyeSBNZXNzYWdlXCIsXG4gICAgICB0aXRsZTogXCJJbnZhbGlkIHRpdGxlIGluIFdBUCBQdXNoIG1lc3NhZ2VcIixcbiAgICAgIHVybDogXCJJbnZhbGlkIHVybCBpbiBXQVAgUHVzaCBtZXNzYWdlXCJcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGdldCBQQVRIKCkge1xuICAgIHJldHVybiBcIi9zbXMvanNvblwiO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q3JlZGVudGlhbHN9IGNyZWRlbnRpYWxzXG4gICAqICAgIGNyZWRlbnRpYWxzIHRvIGJlIHVzZWQgd2hlbiBpbnRlcmFjdGluZyB3aXRoIHRoZSBBUEkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAqICAgIEFkZGl0aW9uIFNNUyBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgdmFyIF9zaG9ydGNvZGUgPSBuZXcgU2hvcnRDb2RlKHRoaXMuY3JlZHMsIHRoaXMub3B0aW9ucyk7XG5cbiAgICB0aGlzLnNob3J0Y29kZUFsZXJ0ID0gX3Nob3J0Y29kZS5zaG9ydGNvZGVBbGVydC5iaW5kKF9zaG9ydGNvZGUpO1xuICAgIHRoaXMuc2hvcnRjb2RlMkZBID0gX3Nob3J0Y29kZS5zaG9ydGNvZGUyRkEuYmluZChfc2hvcnRjb2RlKTtcbiAgICB0aGlzLnNob3J0Y29kZU1hcmtldGluZyA9IF9zaG9ydGNvZGUuc2hvcnRjb2RlTWFya2V0aW5nLmJpbmQoX3Nob3J0Y29kZSk7XG4gIH1cblxuICBfc2VuZFJlcXVlc3QoZW5kcG9pbnQsIG1ldGhvZCwgY2FsbGJhY2spIHtcbiAgICBlbmRwb2ludC5wYXRoID1cbiAgICAgIGVuZHBvaW50LnBhdGggK1xuICAgICAgKGVuZHBvaW50LnBhdGguaW5kZXhPZihcIj9cIikgPiAwID8gXCImXCIgOiBcIj9cIikgK1xuICAgICAgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHtcbiAgICAgICAgYXBpX2tleTogdGhpcy5jcmVkcy5hcGlLZXksXG4gICAgICAgIGFwaV9zZWNyZXQ6IHRoaXMuY3JlZHMuYXBpU2VjcmV0XG4gICAgICB9KTtcbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KGVuZHBvaW50LCBtZXRob2QsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIF9zZW5kTWVzc2FnZShkYXRhLCBjYWxsYmFjaykge1xuICAgIGlmICghZGF0YS5mcm9tKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLnNlbmRlcikpO1xuICAgIH0gZWxzZSBpZiAoIWRhdGEudG8pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudG8pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIHBhdGggPSBNZXNzYWdlLlBBVEggKyBcIj9cIiArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShkYXRhKTtcbiAgICAgIHRoaXMub3B0aW9ucy5sb2dnZXIuaW5mbyhcbiAgICAgICAgXCJzZW5kaW5nIG1lc3NhZ2UgZnJvbSBcIiArXG4gICAgICAgICAgZGF0YS5mcm9tICtcbiAgICAgICAgICBcIiB0byBcIiArXG4gICAgICAgICAgZGF0YS50byArXG4gICAgICAgICAgXCIgd2l0aCBtZXNzYWdlIFwiICtcbiAgICAgICAgICBkYXRhLnRleHRcbiAgICAgICk7XG4gICAgICB0aGlzLl9zZW5kUmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5yZXN0SG9zdCB8fCBcInJlc3QubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogcGF0aFxuICAgICAgICB9LFxuICAgICAgICBcIlBPU1RcIixcbiAgICAgICAgZnVuY3Rpb24oZXJyLCBhcGlSZXNwb25zZSkge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICFlcnIgJiZcbiAgICAgICAgICAgIGFwaVJlc3BvbnNlLnN0YXR1cyAmJlxuICAgICAgICAgICAgYXBpUmVzcG9uc2UubWVzc2FnZXNbMF0uc3RhdHVzID4gMFxuICAgICAgICAgICkge1xuICAgICAgICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgICAgICAgbmV3IEVycm9yKGFwaVJlc3BvbnNlLm1lc3NhZ2VzWzBdW1wiZXJyb3ItdGV4dFwiXSksXG4gICAgICAgICAgICAgIGFwaVJlc3BvbnNlXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGVyciwgYXBpUmVzcG9uc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRTbXMoc2VuZGVyLCByZWNpcGllbnQsIG1lc3NhZ2UsIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLm1zZykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIWNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrID0gb3B0cztcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcImZyb21cIl0gPSBzZW5kZXI7XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widGV4dFwiXSA9IG1lc3NhZ2U7XG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZShvcHRzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kQmluYXJ5TWVzc2FnZShzZW5kZXIsIHJlY2lwaWVudCwgYm9keSwgdWRoLCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghYm9keSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy5ib2R5KSk7XG4gICAgfSBlbHNlIGlmICghdWRoKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLnVkaCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIWNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrID0gb3B0cztcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcImZyb21cIl0gPSBzZW5kZXI7XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widHlwZVwiXSA9IFwiYmluYXJ5XCI7XG4gICAgICBvcHRzW1wiYm9keVwiXSA9IGJvZHk7XG4gICAgICBvcHRzW1widWRoXCJdID0gdWRoO1xuICAgICAgdGhpcy5fc2VuZE1lc3NhZ2Uob3B0cywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZFdhcFB1c2hNZXNzYWdlKHNlbmRlciwgcmVjaXBpZW50LCB0aXRsZSwgdXJsLCB2YWxpZGl0eSwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIXRpdGxlKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLnRpdGxlKSk7XG4gICAgfSBlbHNlIGlmICghdXJsKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLnVybCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIHZhbGlkaXR5ID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgY2FsbGJhY2sgPSB2YWxpZGl0eTtcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgICB2YWxpZGl0eSA9IDg2NDAwMDAwO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBvcHRzID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1wiZnJvbVwiXSA9IHNlbmRlcjtcbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0eXBlXCJdID0gXCJ3YXBwdXNoXCI7XG4gICAgICBvcHRzW1widGl0bGVcIl0gPSB0aXRsZTtcbiAgICAgIG9wdHNbXCJ2YWxpZGl0eVwiXSA9IHZhbGlkaXR5O1xuICAgICAgb3B0c1tcInVybFwiXSA9IHVybDtcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKG9wdHMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICBzZWFyY2goaWQsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHR5cGVvZiBpZCA9PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gdGhpcy5vcHRpb25zLnJlc3QuZ2V0KFxuICAgICAgICBcIi9zZWFyY2gvbWVzc2FnZVwiLFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6IGlkXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSB3ZSBleHBlY3QgYW4gYXJyYXlcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLnJlc3QuZ2V0KFxuICAgICAgXCIvc2VhcmNoL21lc3NhZ2VzXCIsXG4gICAgICB7XG4gICAgICAgIGlkczogaWRcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBzZWFyY2hSZWplY3Rpb25zKHRvLCBkYXRlLCBjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICBcIi9zZWFyY2gvcmVqZWN0aW9uc1wiLFxuICAgICAge1xuICAgICAgICB0byxcbiAgICAgICAgZGF0ZVxuICAgICAgfSxcbiAgICAgIGNhbGxiYWNrXG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBNZXNzYWdlO1xuIl19