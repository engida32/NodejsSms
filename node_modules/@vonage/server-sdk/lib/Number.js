"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Pricing = _interopRequireDefault(require("./Pricing"));

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Number {
  static get PATH() {
    return "/number";
  }

  static get ERROR_MESSAGES() {
    return {
      optionsNotAnObject: "Options parameter should be a dictionary. Check the docs for valid properties for options",
      countrycode: "Invalid Country Code",
      msisdn: "Invalid MSISDN passed"
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition Number options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
    this._pricing = new _Pricing.default(credentials, options);
  }
  /**
   * TODO: remove with next major release
   */


  getPricing() {
    this._pricing.get.apply(this, arguments);
  }
  /**
   * TODO: remove with next major release
   */


  getPhonePricing() {
    this._pricing.getPhone.apply(this, arguments);
  }
  /**
   * TODO: document
   */


  get(options, callback) {
    if (typeof options === "function") {
      callback = options;
      options = {};
    } else if (typeof options !== "object") {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.optionsNotAnObject));
    }

    options.api_key = options.api_key || this.creds.apiKey;
    options.api_secret = options.api_secret || this.creds.apiSecret;
    this.options.httpClient.request({
      path: _Utils.default.createPathWithQuery("/account".concat(Number.PATH, "s"), options)
    }, callback);
  }
  /**
   * TODO: document
   */


  search(countryCode, pattern, callback) {
    var params = {
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    };

    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else {
      params["country"] = countryCode;

      if (typeof pattern === "function") {
        callback = pattern;
      } else if (typeof pattern === "object") {
        for (var arg in pattern) {
          params[arg] = pattern[arg];
        }
      } else {
        params["pattern"] = pattern;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/search"), params)
      }, callback);
    }
  }
  /**
   * TODO: document
   */


  buy(countryCode, msisdn, targetApiKey, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      var opts = {
        country: countryCode,
        msisdn,
        api_key: this.creds.apiKey,
        api_secret: this.creds.apiSecret
      };

      if (targetApiKey instanceof Function) {
        callback = targetApiKey;
      } else {
        opts.target_api_key = targetApiKey;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/buy"), opts)
      }, "POST", callback);
    }
  }
  /**
   * TODO: document
   */


  cancel(countryCode, msisdn, targetApiKey, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      var opts = {
        country: countryCode,
        msisdn,
        api_key: this.creds.apiKey,
        api_secret: this.creds.apiSecret
      };

      if (targetApiKey instanceof Function) {
        callback = targetApiKey;
      } else {
        opts.target_api_key = targetApiKey;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/cancel"), opts)
      }, "POST", callback);
    }
  }
  /**
   * TODO: document
   */


  update(countryCode, msisdn, params, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      params["country"] = countryCode;
      params["msisdn"] = msisdn;
      params["api_key"] = this.creds.apiKey;
      params["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/update"), params)
      }, "POST", callback);
    }
  }

}

var _default = Number;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OdW1iZXIuanMiXSwibmFtZXMiOlsiTnVtYmVyIiwiUEFUSCIsIkVSUk9SX01FU1NBR0VTIiwib3B0aW9uc05vdEFuT2JqZWN0IiwiY291bnRyeWNvZGUiLCJtc2lzZG4iLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX3ByaWNpbmciLCJQcmljaW5nIiwiZ2V0UHJpY2luZyIsImdldCIsImFwcGx5IiwiYXJndW1lbnRzIiwiZ2V0UGhvbmVQcmljaW5nIiwiZ2V0UGhvbmUiLCJjYWxsYmFjayIsIlV0aWxzIiwic2VuZEVycm9yIiwiRXJyb3IiLCJhcGlfa2V5IiwiYXBpS2V5IiwiYXBpX3NlY3JldCIsImFwaVNlY3JldCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwicGF0aCIsImNyZWF0ZVBhdGhXaXRoUXVlcnkiLCJzZWFyY2giLCJjb3VudHJ5Q29kZSIsInBhdHRlcm4iLCJwYXJhbXMiLCJsZW5ndGgiLCJhcmciLCJidXkiLCJ0YXJnZXRBcGlLZXkiLCJvcHRzIiwiY291bnRyeSIsIkZ1bmN0aW9uIiwidGFyZ2V0X2FwaV9rZXkiLCJjYW5jZWwiLCJ1cGRhdGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBRUE7Ozs7QUFFQSxNQUFNQSxNQUFOLENBQWE7QUFDWCxhQUFXQyxJQUFYLEdBQWtCO0FBQ2hCLFdBQU8sU0FBUDtBQUNEOztBQUVELGFBQVdDLGNBQVgsR0FBNEI7QUFDMUIsV0FBTztBQUNMQyxNQUFBQSxrQkFBa0IsRUFDaEIsMkZBRkc7QUFHTEMsTUFBQUEsV0FBVyxFQUFFLHNCQUhSO0FBSUxDLE1BQUFBLE1BQU0sRUFBRTtBQUpILEtBQVA7QUFNRDtBQUNEO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0VDLEVBQUFBLFdBQVcsQ0FBQ0MsV0FBRCxFQUE0QjtBQUFBLFFBQWRDLE9BQWMsdUVBQUosRUFBSTtBQUNyQyxTQUFLQyxLQUFMLEdBQWFGLFdBQWI7QUFDQSxT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M0MsRUFBOEM7QUFDNUNmLHFCQUFNQyxTQUFOLENBQWdCRixRQUFoQixFQUEwQixJQUFJRyxLQUFKLENBQVVyQixNQUFNLENBQUNFLGNBQVAsQ0FBc0JFLFdBQWhDLENBQTFCO0FBQ0QsS0FGRCxNQUVPLElBQUksQ0FBQ0MsTUFBTCxFQUFhO0FBQ2xCYyxxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVckIsTUFBTSxDQUFDRSxjQUFQLENBQXNCRyxNQUFoQyxDQUExQjtBQUNELEtBRk0sTUFFQTtBQUNMNEIsTUFBQUEsTUFBTSxDQUFDLFNBQUQsQ0FBTixHQUFvQkYsV0FBcEI7QUFDQUUsTUFBQUEsTUFBTSxDQUFDLFFBQUQsQ0FBTixHQUFtQjVCLE1BQW5CO0FBQ0E0QixNQUFBQSxNQUFNLENBQUMsU0FBRCxDQUFOLEdBQW9CLEtBQUt4QixLQUFMLENBQVdjLE1BQS9CO0FBQ0FVLE1BQUFBLE1BQU0sQ0FBQyxZQUFELENBQU4sR0FBdUIsS0FBS3hCLEtBQUwsQ0FBV2dCLFNBQWxDO0FBRUEsV0FBS2pCLE9BQUwsQ0FBYWtCLFVBQWIsQ0FBd0JDLE9BQXhCLENBQ0U7QUFDRUMsUUFBQUEsSUFBSSxFQUFFVCxlQUFNVSxtQkFBTixXQUE2QjdCLE1BQU0sQ0FBQ0MsSUFBcEMsY0FBbURnQyxNQUFuRDtBQURSLE9BREYsRUFJRSxNQUpGLEVBS0VmLFFBTEY7QUFPRDtBQUNGOztBQXJMVTs7ZUF3TEVsQixNIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBQcmljaW5nIGZyb20gXCIuL1ByaWNpbmdcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmNsYXNzIE51bWJlciB7XG4gIHN0YXRpYyBnZXQgUEFUSCgpIHtcbiAgICByZXR1cm4gXCIvbnVtYmVyXCI7XG4gIH1cblxuICBzdGF0aWMgZ2V0IEVSUk9SX01FU1NBR0VTKCkge1xuICAgIHJldHVybiB7XG4gICAgICBvcHRpb25zTm90QW5PYmplY3Q6XG4gICAgICAgIFwiT3B0aW9ucyBwYXJhbWV0ZXIgc2hvdWxkIGJlIGEgZGljdGlvbmFyeS4gQ2hlY2sgdGhlIGRvY3MgZm9yIHZhbGlkIHByb3BlcnRpZXMgZm9yIG9wdGlvbnNcIixcbiAgICAgIGNvdW50cnljb2RlOiBcIkludmFsaWQgQ291bnRyeSBDb2RlXCIsXG4gICAgICBtc2lzZG46IFwiSW52YWxpZCBNU0lTRE4gcGFzc2VkXCJcbiAgICB9O1xuICB9XG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbiBOdW1iZXIgb3B0aW9ucy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKGNyZWRlbnRpYWxzLCBvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmNyZWRzID0gY3JlZGVudGlhbHM7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcblxuICAgIHRoaXMuX3ByaWNpbmcgPSBuZXcgUHJpY2luZyhjcmVkZW50aWFscywgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogcmVtb3ZlIHdpdGggbmV4dCBtYWpvciByZWxlYXNlXG4gICAqL1xuICBnZXRQcmljaW5nKCkge1xuICAgIHRoaXMuX3ByaWNpbmcuZ2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogcmVtb3ZlIHdpdGggbmV4dCBtYWpvciByZWxlYXNlXG4gICAqL1xuICBnZXRQaG9uZVByaWNpbmcoKSB7XG4gICAgdGhpcy5fcHJpY2luZy5nZXRQaG9uZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBnZXQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgICAgb3B0aW9ucyA9IHt9O1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMub3B0aW9uc05vdEFuT2JqZWN0KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBvcHRpb25zLmFwaV9rZXkgPSBvcHRpb25zLmFwaV9rZXkgfHwgdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgb3B0aW9ucy5hcGlfc2VjcmV0ID0gb3B0aW9ucy5hcGlfc2VjcmV0IHx8IHRoaXMuY3JlZHMuYXBpU2VjcmV0O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShgL2FjY291bnQke051bWJlci5QQVRIfXNgLCBvcHRpb25zKVxuICAgICAgfSxcbiAgICAgIGNhbGxiYWNrXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VhcmNoKGNvdW50cnlDb2RlLCBwYXR0ZXJuLCBjYWxsYmFjaykge1xuICAgIGxldCBwYXJhbXMgPSB7XG4gICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmFwaUtleSxcbiAgICAgIGFwaV9zZWNyZXQ6IHRoaXMuY3JlZHMuYXBpU2VjcmV0XG4gICAgfTtcbiAgICBpZiAoIWNvdW50cnlDb2RlIHx8IGNvdW50cnlDb2RlLmxlbmd0aCAhPT0gMikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTnVtYmVyLkVSUk9SX01FU1NBR0VTLmNvdW50cnljb2RlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtc1tcImNvdW50cnlcIl0gPSBjb3VudHJ5Q29kZTtcbiAgICAgIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gcGF0dGVybjtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdHRlcm4gPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgZm9yICh2YXIgYXJnIGluIHBhdHRlcm4pIHtcbiAgICAgICAgICBwYXJhbXNbYXJnXSA9IHBhdHRlcm5bYXJnXTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcGFyYW1zW1wicGF0dGVyblwiXSA9IHBhdHRlcm47XG4gICAgICB9XG4gICAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShgJHtOdW1iZXIuUEFUSH0vc2VhcmNoYCwgcGFyYW1zKVxuICAgICAgICB9LFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIGJ1eShjb3VudHJ5Q29kZSwgbXNpc2RuLCB0YXJnZXRBcGlLZXksIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFjb3VudHJ5Q29kZSB8fCBjb3VudHJ5Q29kZS5sZW5ndGggIT09IDIpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE51bWJlci5FUlJPUl9NRVNTQUdFUy5jb3VudHJ5Y29kZSkpO1xuICAgIH0gZWxzZSBpZiAoIW1zaXNkbikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTnVtYmVyLkVSUk9SX01FU1NBR0VTLm1zaXNkbikpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgb3B0cyA9IHtcbiAgICAgICAgY291bnRyeTogY291bnRyeUNvZGUsXG4gICAgICAgIG1zaXNkbixcbiAgICAgICAgYXBpX2tleTogdGhpcy5jcmVkcy5hcGlLZXksXG4gICAgICAgIGFwaV9zZWNyZXQ6IHRoaXMuY3JlZHMuYXBpU2VjcmV0XG4gICAgICB9O1xuXG4gICAgICBpZiAodGFyZ2V0QXBpS2V5IGluc3RhbmNlb2YgRnVuY3Rpb24pIHtcbiAgICAgICAgY2FsbGJhY2sgPSB0YXJnZXRBcGlLZXk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvcHRzLnRhcmdldF9hcGlfa2V5ID0gdGFyZ2V0QXBpS2V5O1xuICAgICAgfVxuXG4gICAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShgJHtOdW1iZXIuUEFUSH0vYnV5YCwgb3B0cylcbiAgICAgICAgfSxcbiAgICAgICAgXCJQT1NUXCIsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgY2FuY2VsKGNvdW50cnlDb2RlLCBtc2lzZG4sIHRhcmdldEFwaUtleSwgY2FsbGJhY2spIHtcbiAgICBpZiAoIWNvdW50cnlDb2RlIHx8IGNvdW50cnlDb2RlLmxlbmd0aCAhPT0gMikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTnVtYmVyLkVSUk9SX01FU1NBR0VTLmNvdW50cnljb2RlKSk7XG4gICAgfSBlbHNlIGlmICghbXNpc2RuKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMubXNpc2RuKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBvcHRzID0ge1xuICAgICAgICBjb3VudHJ5OiBjb3VudHJ5Q29kZSxcbiAgICAgICAgbXNpc2RuLFxuICAgICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmFwaUtleSxcbiAgICAgICAgYXBpX3NlY3JldDogdGhpcy5jcmVkcy5hcGlTZWNyZXRcbiAgICAgIH07XG5cbiAgICAgIGlmICh0YXJnZXRBcGlLZXkgaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICBjYWxsYmFjayA9IHRhcmdldEFwaUtleTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdHMudGFyZ2V0X2FwaV9rZXkgPSB0YXJnZXRBcGlLZXk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGAke051bWJlci5QQVRIfS9jYW5jZWxgLCBvcHRzKVxuICAgICAgICB9LFxuICAgICAgICBcIlBPU1RcIixcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICB1cGRhdGUoY291bnRyeUNvZGUsIG1zaXNkbiwgcGFyYW1zLCBjYWxsYmFjaykge1xuICAgIGlmICghY291bnRyeUNvZGUgfHwgY291bnRyeUNvZGUubGVuZ3RoICE9PSAyKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMuY291bnRyeWNvZGUpKTtcbiAgICB9IGVsc2UgaWYgKCFtc2lzZG4pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE51bWJlci5FUlJPUl9NRVNTQUdFUy5tc2lzZG4pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zW1wiY291bnRyeVwiXSA9IGNvdW50cnlDb2RlO1xuICAgICAgcGFyYW1zW1wibXNpc2RuXCJdID0gbXNpc2RuO1xuICAgICAgcGFyYW1zW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZHMuYXBpS2V5O1xuICAgICAgcGFyYW1zW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZHMuYXBpU2VjcmV0O1xuXG4gICAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShgJHtOdW1iZXIuUEFUSH0vdXBkYXRlYCwgcGFyYW1zKVxuICAgICAgICB9LFxuICAgICAgICBcIlBPU1RcIixcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE51bWJlcjtcbiJdfQ==